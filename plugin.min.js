tinymce.PluginManager.add('youtube', function(editor, url) {

    // Add a button that opens a window
    editor.addButton('youtube', {
        //text: 'Add YouTube video',
        image: tinymce.baseURL + "/plugins/youtube/icon.png",
        tooltip: 'Insert Video',
        onclick: function() {
            var activegrid = null;
            var node = editor.selection.getNode();
            var parents = tinymce.DOM.getParents(node,'div');
            for (var i=0; i < parents.length; i++ ){
                var clases = $(parents[i]).attr("class");
                if(clases){
                    clases = clases.split(" ");
                    for( var n=0; n < clases.length; n++ ){
                        if(clases[n] === "tinymce-video"){
                            if(activegrid === null){
                                activegrid = parents[n];
                            }
                        }
                    }
                }
            }
            
            var path = null; 
            
            if(activegrid !== null){
                path = $(activegrid).find("iframe").attr("src");
                if(path !== ""){
                    var temp = path.split("/");
                    path = temp[temp.length-1];
                    var posInfo = path.indexOf("?showinfo");
                    if(posInfo > 0){
                        path = path.substr(0,posInfo);
                    }
                }
            }
            
            var activeShadow = false;
            if($(activegrid).hasClass("img-raised")){
                activeShadow = true;
            }
            
            // Open window
            editor.windowManager.open({
                title: 'YouTube video',
                body: [
                    {
                        type: 'container',
                        label: '',
                        html: '<b>Introducir url o c√≥digo de video de youtube</b>'
                    },
                    {   type: 'textbox', 
                        name: 'code', 
                        label: '',
                        value: path
                    },
                    {
                        type   : 'checkbox',
                        name   : 'raised',
                        text   : 'Raised shadow',
                        checked : activeShadow
                    }
                ],
                onsubmit: function(e) {
                    // Insert content when the window form is submitted
                    if(e.data.code){
                        var videoCode = e.data.code;
                        var raised = e.data.raised;
                        var posIni = e.data.code.indexOf("=");
                        var posUrl = e.data.code.indexOf("youtube");
                        
                        if(posIni > 0 && posUrl > 0){
                            videoCode = videoCode.substr(posIni + 1, videoCode.length);
                            var posEnd = videoCode.indexOf("&");
                            if(posEnd > 0){
                                videoCode = videoCode.substr(0, posEnd);
                            }
                        }
                        
                        
                        if(path !== null){
                            $(activegrid).find("iframe").attr("src","http://www.youtube.com/embed/" + videoCode + "?showinfo=0");
                            if(raised){
                                $(activegrid).addClass('img-raised');
                            }
                        }else{
                            var shadow = "";
                            if(raised){
                                shadow = "img-raised";
                            }
                            editor.insertContent('<div class="embed-responsive embed-responsive-16by9 ' + shadow + '"><iframe class="embed-responsive-item" ' +
                                                'src="http://www.youtube.com/embed/' + 
                                                videoCode + '?showinfo=0" frameborder="0" ' + 
                                                'allowfullscreen></iframe><div class="embed-responsive-item tinymce-video" style="background-color:transparent; background-image:none;"></div></div>');
                        }
                    }else{
                        tinyMCE.activeEditor.windowManager.alert('Please fill the code field to use YouTube plugin.');
                    }
                }
            });
        }
    });
    
    // Adds a menu item to the tools menu
  editor.addMenuItem('youtube', {
    text: 'Example plugin',
    context: 'tools',
    onclick: function() {
      // Open window with a specific url
      editor.windowManager.open({
        title: 'TinyMCE site',
        url: 'http://www.tinymce.com',
        width: 800,
        height: 600,
        buttons: [{
          text: 'Close',
          onclick: 'close'
        }]
      });
    }
  });
});